@inherits LayoutComponentBase
@namespace HospitalSystemTeamTask.Shared.Layouts
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="page d-flex flex-column" style="min-height: 100vh;">
    <!-- AppBar Section -->
    <MudAppBar Color="Color.Default" Fixed="true" Style="background-color: #1B7D84;">
        <MudText Typo="Typo.body1" Align="Align.Left" Style="color: white; margin-left: 15px;">
            Welcome, @DoctorName!
        </MudText>
        <MudSpacer />
        <MudMenu>
            <ActivatorContent>
                <MudChip T="string" Icon="@Icons.Material.Filled.Person" Style="color: #ffffff;"></MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem OnClick="NavigateToProfile">Profile</MudMenuItem>
                <MudMenuItem OnClick="NavigateToSettings">Settings</MudMenuItem>
                <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>

    <!-- Main Content Section -->
    <div class="d-flex" style="flex: 1; margin-top: 65px;">
        <!-- Added margin-top to push content below the AppBar -->
        <!-- Sidebar -->
        <div style="background: linear-gradient(to bottom, #1B7D84, #33BEC8); color: white; width: 250px; height: calc(100vh - 65px); padding: 1rem;">
            <div class="text-center">
                <img src="/Images/logo.png" alt="Logo" style="max-width: 150px; object-fit: contain;" />
            </div>
            <nav>
                <!-- Home -->
                <NavLink class="nav-link d-flex align-items-center" href="DoctorPage" Match="NavLinkMatch.All" style="color: white; font-weight: bold; font-size: 1.3rem; padding: 0.5rem;">
                    <span class="bi bi-house-door-fill" aria-hidden="true" style="margin-right: 15px;"></span> Home
                </NavLink>

                <!-- Clinic -->
                <NavLink class="nav-link d-flex align-items-center" href="/ClinicPage" style="color: white; font-weight: bold; font-size: 1.3rem; padding: 0.5rem;">
                    <span class="bi bi-building" aria-hidden="true" style="margin-right: 15px;"></span> Clinic
                </NavLink>

                <!-- Patient Record -->
                <NavLink class="nav-link d-flex align-items-center"
                         href="@($"/PatientRecords")"
                         style="color: white; font-weight: bold; font-size: 1.3rem; padding: 0.5rem;">
                    <span class="bi bi-hospital-fill" aria-hidden="true" style="margin-right: 15px;"></span> Patient Record
                </NavLink>
            </nav>
        </div>

        <!-- Main Content -->
        <div style="flex: 1; padding: 1rem; overflow-y: auto; height: calc(100vh - 65px);">
            @Body
        </div>
    </div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private string DoctorName = "Guest";

    protected override async Task OnInitializedAsync()
    {
        DoctorName = await GetDoctorName();
    }

    private async Task<string> GetDoctorName()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var nameClaim = user.Claims.FirstOrDefault(c => c.Type == "name")?.Value;
            return !string.IsNullOrEmpty(nameClaim) ? nameClaim : "Doctor";
        }

        return "Guest";
    }

    private void NavigateToProfile()
    {
        NavigationManager.NavigateTo("/Profile");
    }

    private void NavigateToSettings()
    {
        NavigationManager.NavigateTo("/Settings");
    }

    private void Logout()
    {
        DoctorName = "Guest";
        NavigationManager.NavigateTo("/SignIn");
    }
}
