@layout StaffLayout
@inject IUserService userService
@inject NavigationManager NavigationManager
 
@page "/Staff"

<!-- Add New Staff Button Positioned on the Right -->
<div class="d-flex justify-end" style="margin-bottom: 30px;">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NavigateToAddStaff"
               Style="background-color: #1B7D84; color: white; font-size: 1rem; padding: 10px 10px;">
        Add New Staff
    </MudButton>
</div>

<!-- Search Box -->
<MudTextField T="string"
    Placeholder="Search for User"
    ValueChanged="@OnSearchChanged"
    Immediate="true"
    Adornment="Adornment.End"
    AdornmentIcon="@Icons.Material.Filled.Search"
    Class="mb-4"
    Variant="Variant.Filled"
    Style="margin-bottom: 20px;" />

<!-- Staff Table -->
<MudTable Items="@filteredUsers" Hover="true" SortLabel="Sort By" Style="width: 100%; margin-top: 50px;">
    <HeaderContent>
        <MudTh Style="background-color: #1B7D84; color: white; width: 10%;">User ID</MudTh>
        <MudTh Style="background-color: #1B7D84; color: white; width: 20%;">Name</MudTh>
        <MudTh Style="background-color: #1B7D84; color: white; width: 15%;">Role</MudTh>
        <MudTh Style="background-color: #1B7D84; color: white; width: 15%;">Status</MudTh>
        <MudTh Style="background-color: #1B7D84; color: white; width: 15%;">View</MudTh>
        <MudTh Style="background-color: #1B7D84; color: white; width: 15%;">Edit</MudTh>
        <MudTh Style="background-color: #1B7D84; color: white; width: 15%;">Inactivate</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="User ID">@context.UID</MudTd>
        <MudTd DataLabel="Name">@context.UserName</MudTd>
        <MudTd DataLabel="Role">@context.Role</MudTd>
        <MudTd DataLabel="Status" Style="@GetStatusStyle(context.IsActive)">
            @(context.IsActive ? "Active" : "Inactive")
        </MudTd>
        <MudTd DataLabel="View">
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" OnClick="() => NavigateToView(context.UID)" />
        </MudTd>
        <MudTd DataLabel="Edit">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" OnClick="() => NavigateToEdit(context.UID)" />
        </MudTd>
        <MudTd DataLabel="Inactivate">
            <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)" 
                Color="@(context.IsActive ? Color.Error : Color.Success)" 
                OnClick="() => ToggleUserStatus(context.UID, context.IsActive)" />
        </MudTd>
    </RowTemplate>
</MudTable>

<MudSnackbar />

@code {
    private IEnumerable<UserOutputDTO> users;
    private IEnumerable<UserOutputDTO> filteredUsers;
    private string searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.Information("Initializing staff page.");
            await LoadUsers();
        }
        catch (Exception ex)
        {
            Logger.Error("Error initializing staff page: {ErrorMessage}", ex.Message);
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            Logger.Information("Loading users for staff management.");
            var superAdmins = userService.GetUserByRole("superAdmin");
            var admins = userService.GetUserByRole("admin");
            var doctors = userService.GetUserByRole("doctor");

            users = superAdmins.Concat(admins).Concat(doctors).ToList();
            filteredUsers = users;
            Logger.Information("Successfully loaded users for staff management.");
        }
        catch (Exception ex)
        {
            Logger.Error("Error loading users: {ErrorMessage}", ex.Message);
        }
    }

    private void OnSearchChanged(string search)
    {
        searchQuery = search;
        Logger.Information("Search query updated: {SearchQuery}", searchQuery);

        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            filteredUsers = users;
            Logger.Information("Reset search. Displaying all users.");
        }
        else
        {
            filteredUsers = users.Where(u =>
                u.UserName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                u.Role.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
            Logger.Information("Filtered users based on search query: {SearchQuery}", searchQuery);
        }
    }

    private void NavigateToView(int userId)
    {
        Logger.Information("Navigating to view details of user ID: {UserId}", userId);
        // Implement navigation logic
    }

    private void NavigateToEdit(int userId)
    {
        Logger.Information("Navigating to edit user ID: {UserId}", userId);
        // Implement navigation logic
    }

    private void ToggleUserStatus(int userId, bool isActive)
    {
        try
        {
            Logger.Information("Toggling status for user ID: {UserId}, Current Status: {IsActive}", userId, isActive);
            var userToUpdate = users.FirstOrDefault(u => u.UID == userId);
            if (userToUpdate != null)
            {
                userToUpdate.IsActive = !isActive;
                filteredUsers = users.ToList();
                StateHasChanged();
                Logger.Information("Successfully toggled status for user ID: {UserId}", userId);
            }
        }
        catch (Exception ex)
        {
            Logger.Error("Error toggling user status: {ErrorMessage}", ex.Message);
        }
    }

    private void NavigateToAddStaff()
    {
        Logger.Information("Navigating to add new staff.");
        NavigationManager.NavigateTo("/AddStaff");
    }

    private string GetStatusStyle(bool isActive)
    {
        return isActive ? "color: green;" : "color: red;";
    }
}
