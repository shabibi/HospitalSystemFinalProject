@page "/ManageBranch"
@layout StaffLayout
@inject NavigationManager NavigationManager
@inject IBranchService BranchService
 

<MudContainer MaxWidth="MaxWidth.Medium" Class="my-5">
    <MudText Typo="Typo.h4" Align="Align.Center" Style="color: #1B7D84;">
        Branch Management
    </MudText>
    <MudCard Class="mt-4">
        <MudCardContent>
            <!-- Add Branch Button -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NavigateToAddBranch"
                           Style="background-color: #1B7D84; color: white; font-size: 1rem; padding: 8px 16px;">
                    Add Branch
                </MudButton>
            </div>

            <!-- Branch Table -->
            <MudTable Items="branches" T="Branch" Hover="true" Bordered="true" Striped="true" Elevation="2">
                <HeaderContent>
                    <MudTh>Branch ID</MudTh>
                    <MudTh>Branch Name</MudTh>
                    <MudTh>Location</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.BID</MudTd>
                    <MudTd>@context.BranchName</MudTd>
                    <MudTd>@context.Location</MudTd>
                    <MudTd>
                        <!-- View Button -->
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" OnClick="() => ViewBranch(context.BID)" />
                        <!-- Edit Button -->
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => NavigateToAddBranch(context.BID)" />
                        <!-- Delete Button -->
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteBranch(context.BID)" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Typo="Typo.body1" Align="Align.Center" Style="color: gray;">
                        No branches found.
                    </MudText>
                </NoRecordsContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private List<Branch> branches = new List<Branch>();

    protected override void OnInitialized()
    {
        Logger.Information("ManageBranch page initialized at {Time}", DateTime.Now);

        try
        {
            // Load branches on initialization
            branches = BranchService.GetAllBranches().ToList();
            Logger.Information("Successfully fetched {Count} branches at {Time}", branches.Count, DateTime.Now);
        }
        catch (Exception ex)
        {
            Logger.Error("Error fetching branches: {Error} at {Time}", ex.Message, DateTime.Now);
        }
    }

    private void AddBranch()
    {
        Logger.Information("Navigating to AddBranch page at {Time}", DateTime.Now);
        NavigationManager.NavigateTo("/AddBranch");
    }

    private void NavigateToAddBranch()
    {
        Logger.Information("Navigating to AddBranch page at {Time}", DateTime.Now);
        NavigationManager.NavigateTo("/AddBranch");
    }

    private void NavigateToAddBranch(int? branchId = null)
    {
        if (branchId.HasValue)
        {
            Logger.Information("Navigating to AddBranch page for Branch ID: {BranchId} at {Time}", branchId.Value, DateTime.Now);
            NavigationManager.NavigateTo($"/AddBranch/{branchId.Value}");
        }
        else
        {
            Logger.Information("Navigating to AddBranch page at {Time}", DateTime.Now);
            NavigationManager.NavigateTo("/AddBranch");
        }
    }

    private void EditBranch(int branchId)
    {
        Logger.Information("Navigating to EditBranch page for Branch ID: {BranchId} at {Time}", branchId, DateTime.Now);
        NavigationManager.NavigateTo($"/EditBranch/{branchId}");
    }

    private void DeleteBranch(int branchId)
    {
        try
        {
            Logger.Information("Attempting to delete Branch ID: {BranchId} at {Time}", branchId, DateTime.Now);
            BranchService.SetBranchStatus(branchId, false);

            // Refresh branch list after deletion
            branches = BranchService.GetAllBranches().ToList();
            Logger.Information("Branch ID: {BranchId} deleted successfully at {Time}", branchId, DateTime.Now);
        }
        catch (Exception ex)
        {
            Logger.Error("Error deleting Branch ID: {BranchId}. Error: {Error} at {Time}", branchId, ex.Message, DateTime.Now);
        }
    }

    private void ViewBranch(int branchId)
    {
        Logger.Information("Navigating to ViewBranch page for Branch ID: {BranchId} at {Time}", branchId, DateTime.Now);
        NavigationManager.NavigateTo($"/ViewBranch/{branchId}");
    }
}
