@layout StaffLayout
@page "/AddStaff"
@inject IUserService userService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDoctorService doctorService
@inject IBranchService branchService
@inject IDepartmentService departmentService
@inject IBranchDepartmentService branchDepartmentService

<MudPaper Elevation="4" Class="form-container" Style="width: 100%; align-content:center;" Align="Align.Center">
    <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-4" Style="color: #1B7D84;">
        Add New Staff
    </MudText>
    <MudForm Model="newStaffInput" @ref="form" Valid="isFormValid" OnValidSubmit="SubmitForm">
        <MudItem xs="12" Class="mb-4">
            <!-- Staff Name Input -->
            <MudTextField Label="Staff Name" @bind-Value="newStaffInput.UserName" Required="true" FullWidth="true" />
        </MudItem>
        <MudItem xs="12" Class="mb-4">
            <!-- Role Dropdown -->
            <MudSelect T="string" Label="Role" @bind-Value="newStaffInput.Role" Required="true" FullWidth="true">
                @foreach (var role in roles)
                {
                    <MudSelectItem T="string" Value="@role">@role</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" Class="mb-4">
            <!-- Phone Number Input -->
            <MudTextField Label="Phone Number" @bind-Value="newStaffInput.Phone" FullWidth="true" />
        </MudItem>

        <!-- Additional fields for Doctor -->
        @if (newStaffInput.Role == "Doctor")
        {
            <MudItem xs="12" Class="mb-4">
                <!-- Degree -->
                <MudTextField Label="Degree" @bind-Value="doctorInput.Degree" FullWidth="true" />
            </MudItem>
            <MudItem xs="12" Class="mb-4">
                <!-- Working Years -->
                <MudTextField Label="Working Years" @bind-Value="doctorInput.WorkingYear" FullWidth="true" />
            </MudItem>
            <MudItem xs="12" Class="mb-4">
                <!-- Level -->
                <MudTextField Label="Level" @bind-Value="doctorInput.Level" FullWidth="true" />
            </MudItem>

            <!-- Branch Selection -->
            <MudSelect MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectionText))" MultiSelection="true" @bind-Value="selectedBranch" T="string" Label="Branches" AdornmentIcon="@Icons.Material.Filled.Search">
                @foreach (var branch in branches)
                {
                    <MudSelectItem T="string" Value="@branch">@branch</MudSelectItem>
                }
            </MudSelect>

            <!-- Department Selection -->
            <MudItem xs="12" Class="mb-4">
                <MudSelect T="int" Label="Department" @bind-Value="selectedDepartment" FullWidth="true">
                    @foreach (var department in departments)
                    {
                        <MudSelectItem T="int" Value="@department.DepId" Style="font-size: 1rem; font-weight: bold; color: #1B7D84;">
                            <MudIcon Icon="@Icons.Material.Filled.Home" Color="Color.Primary" Style="margin-right: 8px;" />
                            @department.DepartmentName
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        }

        <MudItem xs="12" Class="d-flex justify-space-between mt-4">
            <!-- Submit and Cancel Buttons -->
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitForm" Disabled="!form.IsValid">
                Submit
            </MudButton>
            <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="NavigateBack">
                Cancel
            </MudButton>
        </MudItem>
    </MudForm>
</MudPaper>

@code {
    private User newStaffInput = new();
    private DoctorInput doctorInput = new(); // This is for the doctor-specific details
    private MudForm form;
    private bool isFormValid = false;
    private string[] roles = { "Admin", "Doctor" };
    private int  branchId; 
    private List<string> branches = new List<string>();  // List of branch names
    private List<DepDTO> departments = new();           // List of departments
    private string selectedBranch { set; get; } = "No Selected";         // Multi-selection for branch names
    private int selectedDepartment;                       // Selected department

    protected override async Task OnInitializedAsync()
    {
        Log.Information("Navigated to Add Staff page at {Time}", DateTime.Now);

        try
        {
            branches = branchService.GetAllBranches().Select(b => b.BranchName).ToList();
            if (!branches.Any())
            {
                Snackbar.Add("No branches found.", Severity.Warning);
                Log.Warning("No branches found at {Time}", DateTime.Now);
            }

            departments = departmentService.GetAllDepartments().ToList();
            if (!departments.Any())
            {
                Snackbar.Add("No departments available.", Severity.Warning);
                Log.Warning("No departments available at {Time}", DateTime.Now);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading branches: {ex.Message}", Severity.Error);
            Log.Error("Error loading branches: {Error} at {Time}", ex.Message, DateTime.Now);
        }
    }

    // Multi-selection handler for branches
    private string GetMultiSelectionText(List<string> selectedValues)
    {
        if (selectedValues == null || !selectedValues.Any())
        {
            try
            {
                var departmentIds = await Task.Run(() => branchDepartmentService.GetDepartmentsByBranch(selectedBranchId));
                if (departmentIds == null || !departmentIds.Any())
                {
                    Snackbar.Add("No departments found for the selected branch.", Severity.Warning);
                    Log.Warning("No departments found for branch ID {BranchId} at {Time}", selectedBranchId, DateTime.Now);
                    return;
                }

                departments.Clear();
                departments = departmentIds.ToList();
                Log.Information("Departments loaded for branch ID {BranchId} at {Time}", selectedBranchId, DateTime.Now);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading departments for branch: {ex.Message}", Severity.Error);
                Log.Error("Error loading departments for branch ID {BranchId}: {Error} at {Time}", selectedBranchId, ex.Message, DateTime.Now);
            }
        }

        return string.Join(", ", selectedValues);
    }

    private async Task SubmitForm()
    {
        if (form.IsValid)
        {
            try
            {
                Log.Information("Adding new staff with UserName: {UserName} at {Time}", newStaffInput.UserName, DateTime.Now);
                await userService.AddStaff(newStaffInput);

                if (newStaffInput.Role == "Doctor" && selectedDepartment != 0)
                {
                    doctorInput.DID = doctorId;
                    doctorInput.DepID = selectedDepartment;
                    doctorInput.CurrentBrunch = branchId;
                    doctorService.AddDoctor(doctorInput);
                    Log.Information("Doctor-specific details added for UserName: {UserName} at {Time}", newStaffInput.UserName, DateTime.Now);
                }

                Snackbar.Add("New staff member added successfully!", Severity.Success);
                Log.Information("New staff added successfully with UserName: {UserName} at {Time}", newStaffInput.UserName, DateTime.Now);

                await Task.Delay(2000);
                NavigateBack();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding staff: {ex.Message}", Severity.Error);
                Log.Error("Error adding new staff with UserName: {UserName}. Error: {Error} at {Time}", newStaffInput.UserName, ex.Message, DateTime.Now);
            }
        }
        else
        {
            Snackbar.Add("Please fill out all required fields.", Severity.Warning);
            Log.Warning("Form submission failed due to validation errors at {Time}", DateTime.Now);
        }
    }

    private void NavigateBack()
    {
        Log.Information("User canceled Add Staff operation at {Time}", DateTime.Now);
        NavigationManager.NavigateTo("/Staff");
    }
}
